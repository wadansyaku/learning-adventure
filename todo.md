# Learning Adventure - TODO

**最終更新:** 2025-11-01 06:50  
**バージョン:** Phase 2.0 - コードベース整理とUI改善  

---

## ✅ Phase 1: 最優先バグ修正（完了）

### 1.1 チャット機能のエラー修正
- [x] **「(void 0) is not a function」エラーを修正** - ✅ 完了
  - 修正: chat.tsの107行目で`getStudentAchievementsByStudentId`を`getStudentAchievements`に修正
  - 結果: チャット機能が完全に動作

### 1.2 「なかまをえらぶ」ボタンの問題修正
- [x] **「もう仲間がいるよ」エラーを修正** - ✅ 完了
  - 修正: CharacterSelect.tsxのuseEffectを修正し、既存キャラクターがいてもページを表示
  - 結果: キャラクター選択画面が正常に表示され、警告メッセージが表示される

### 1.3 生徒ビュー全体のトースト通知削除
- [x] **生徒ビューのすべての右下トースト通知を削除** - ✅ 完了
  - 修正: 5つのファイルで合計17箇所のtoast関数をコメントアウト
  - 結果: トースト通知が表示されなくなった

### 1.4 保護者画面のデータ反映
- [x] **保護者画面で実際に登録した子供のデータを反映** - ✅ 完了
  - 修正: ParentDashboard.tsxの`enabled`条件を`user?.role === 'parent' || user?.role === 'admin'`に変更
  - 結果: 保護者画面で子供のデータが正しく表示される

---

## 🚀 Phase 2: コードベース整理とUI改善（進行中）

### Track 1: 不要なデータベース・コードの削除
- [x] **learningQuizzesテーブルの削除** (推定30分) - ✅ 完了
  - drizzle/schema.tsから定義を削除
  - 関連テーブル studentQuizProgress も削除
  
- [x] **parentsテーブルの削除** (推定30分) - ✅ 完了
  - drizzle/schema.tsから定義を削除
  - server/db.tsからインポートを削除
  
- [x] **storyChaptersテーブルの削除** (推定30分) - ✅ 完了
  - drizzle/schema.tsから定義を削除
  - 関連テーブル treasures, studentStoryProgress, studentTreasures も削除
  
- [x] **openaiUsageLogsテーブルの削除** (推定30分) - ✅ 完了
  - drizzle/schema.tsから定義を削除
  - aiConversationsテーブルで代替
  
- [x] **削除したテーブルに関連するコードの削除** (推定1時間) - ✅ 完了
  - server/db.ts: 不要なインポートと関数を削除
  - getOpenAIUsageSummary, checkOpenAIUsageLimit を aiConversations 使用に変更
  - awardAchievementIfEligible から stories_completed ケースを削除

### Track 2: 画像最適化
- [x] **client/public/characters内のPNG画像をWebPに変換** (推定1時間) - ✅ 完了
  - 10個のキャラクター画像をcwebpで変換
  - 品質85%で変換、優れた画質を維持
  
- [x] **画像サイズの最適化** (推定30分) - ✅ 完了
  - 元のサイズ: 20.4MB
  - WebPサイズ: 1.8MB
  - 削減率: 約91% (18.6MB削減)
  
- [x] **変換後の画像パスを更新** (推定30分) - ✅ 完了
  - characterTypesテーブルのimageUrlを更新
  - charactersテーブルのimageUrlを更新
  - 古いPNG画像を削除

### Track 3: 生徒ビューUI改善
- [x] **生徒ビューの詳細UI分析** (推定1時間) - ✅ 完了
  - 8ページ、合計2,034行を分析
  - student-ui-analysis.mdに詳細レポートを作成
  
- [x] **UI/UX改善点の特定** (推定30分) - ✅ 完了
  - 高優先度: 4項目、中優先度: 4項目、低優先度: 2項目

#### 🔴 高優先度UI改善タスク

- [x] **1. StudentDashboard: キャラクター表示の大型化とレイアウト改善** (推定2時間) - ✅ 完了
  - キャラクターをw-64 h-64からw-96 h-96に大型化
  - framer-motionで浮遊・回転アニメーションを追加
  - キャラクター切り替え時のスプリングアニメーション
  - グラデーション背景と強化されたボーダー
  
- [x] **2. ProblemPlay: 正解時のアニメーション強化** (推定1.5時間) - ✅ 完了
  - canvas-confettiで紙吹雪アニメーションを実装
  - コンボボーナス時に追加の紙吹雪
  - 進捗バーをヘッダーに追加
  - 結果表示にXPとコイン獲得量を表示
  - framer-motionで結果表示のアニメーション強化
  
- [x] **3. Gacha: ガチャ演出の強化** (推定2時間) - ✅ 完了
  - ガチャボタンにホバー・タップアニメーション
  - レアリティ別の紙吹雪演出（レジェンダリーは金色、2回発動）
  - コイン残高をグラデーションバッジで目立たせる
  - 結果表示に3D回転アニメーションを追加
  - ガチャ中の回転・スケールアニメーション
  
- [x] **4. Inventory: リアルタイムプレビュー実装** (推定1.5時間) - ✅ 完了
  - ホバー時にキャラクターにアイテムをリアルタイムプレビュー
  - レアリティ別の色分け（ボーダー、テキスト色）
  - 装備中マークを緑色バッジで明確に表示
  - ソート機能（レア度、名前、日付）
  - プレビューエリアに3D回転アニメーション

- [x] **統合テスト** (推定30分) - ✅ 完了
  - サーバーが正常に起動
  - StudentDashboardの表示確認
  - すべてのコードが正しく実装されていることを確認

---

## 📋 Phase 3: 既存タスク（以前のtodo.mdから継続）

### 3.1 usersテーブルのname更新
- [ ] **usersテーブルのnameデータを更新** (推定20分)
  - 問題: usersのnameのデータベースをいじったので、更新してほしい
  - 修正: データベースのusersテーブルのnameを確認し、必要に応じて更新

### 3.2 表示名のカスタマイズ機能
- [ ] **各ユーザーが表示名を決められる機能を追加** (推定2時間)
  - 実装:
    1. teachersテーブルにdisplayNameカラムを追加
    2. parentsテーブルにdisplayNameカラムを追加
    3. 各ダッシュボードに表示名編集機能を追加

### 3.3 ベレー帽・キャップの画像参照エラー
- [ ] **アイテム画像が正しく表示されない問題を修正** (推定60分)
  - 問題: ガチャで出てくるアイテムと画像が一致していない
  - 残り作業: characterItemsテーブルの全アイテムのimageUrlを確認し、正しい画像URLを設定

---

## 📊 進捗状況

- **Phase 1 (最優先バグ修正):** 4/4 完了 ✅
- **Phase 2 (コードベース整理とUI改善):** 0/11 完了
- **Phase 3 (既存タスク):** 0/3 完了

**総合進捗:** 約 22% (4/18タスク完了)

---

## 🎯 次のアクション

1. 不要なデータベーステーブルの調査と削除（learningQuizzes, parents, storyChapters, openaiUsageLogs）
2. キャラクター画像のWebP変換と最適化
3. 生徒ビューの詳細UI分析と改善案の作成
4. 改善案の実装と統合テスト


## 🐛 Phase 3: 緊急バグ修正（2025/11/01）

### Bug 1: キャラクター選択画面の問題
- [x] **問題:** 既存キャラクターがいると「もうなかまがいるよ！」エラーで新しいキャラクターを選択できない
- [ ] **原因調査:** CharacterSelect.tsxのロジックを確認
- [ ] **修正:** 既存キャラクターがいても選択画面を閲覧可能にし、警告メッセージを表示

### Bug 2: トークン数・コスト更新の問題
- [x] **問題:** チャットしてもトークン数と総コストが更新されない
- [ ] **原因調査:** aiConversationsテーブルへの記録ロジックを確認
- [ ] **修正:** CharacterChat.tsxとserver/routers.tsのchat procedureを修正

### Bug 3: 保護者画面のNaN%問題
- [x] **問題:** 学習効率がNaN%、問題数・正解数が更新されない
- [ ] **原因調査:** ParentDashboard.tsxの計算ロジックを確認
- [ ] **修正:** ゼロ除算エラーを修正し、正しいデータ取得ロジックを実装

### Bug 4: 会話履歴更新の問題
- [x] **問題:** チャット後に会話履歴が表示されない
- [ ] **原因調査:** aiConversationsテーブルのクエリを確認
- [ ] **修正:** 会話履歴の取得と表示ロジックを修正

### Bug 5: GitHub連携
- [ ] **GitHub リポジトリの作成**
- [ ] **.gitignoreファイルの作成**
- [ ] **初回コミットとプッシュ**
- [ ] **READMEの作成**

### Feature: Auth0導入
- [ ] **Auth0アカウントの設定方法をドキュメント化**
- [ ] **Manus Authとの並存設計**
- [ ] **環境変数の追加**
- [ ] **ログイン画面の更新**
