# Learning Adventure - TODO

**最終更新:** 2025-10-29  
**バージョン:** 96310742  
**分析レポート:** [SYSTEM_ANALYSIS.md](./docs/SYSTEM_ANALYSIS.md)  
**データ整備計画:** [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md)

---

## 📊 プロジェクト概要

| 指標 | 値 |
|------|-----|
| 総コード行数 | 15,905行 |
| データベーステーブル数 | 21テーブル |
| API関数数 | 48関数 |
| tRPCエンドポイント数 | 48エンドポイント |
| 主要ページ数 | 17ページ |
| 実装完了度 | 約80% |

---

## ✅ 完了済み機能

### コア機能
- [x] データベーススキーマ設計(21テーブル)
- [x] バックエンドAPI実装(tRPC、48関数)
- [x] 認証システム(ロールベース: admin, teacher, parent, student)
- [x] 生徒ダッシュボード
- [x] 問題回答システム(500問)
- [x] レベル・XP・コインシステム

### ゲーミフィケーション
- [x] ログインボーナスシステム
- [x] ガチャシステム(100アイテム、4段階レアリティ)
- [x] 実績システム(20実績)
- [x] ストーリーシステム(10章、30宝物)
- [x] 学習クイズ統合(32問)
- [x] 10種類の動物キャラクター画像統合
- [x] デイリーミッションシステム(5種類)
- [x] デイリーミッション自動進捗更新

### 管理機能
- [x] 講師ダッシュボード
- [x] 課題作成フォーム
- [x] 問題作成フォーム
- [x] 保護者ダッシュボード(基本機能)
- [x] 管理者ダッシュボード
- [x] ロールベース権限制御
- [x] 管理者の直接アクセス(ロール切り替え不要)

### AI統合
- [x] ChatGPT統合(キャラクター会話)
- [x] OpenAI使用状況記録システム
- [x] トークン・コスト計算
- [x] 管理者画面でのOpenAI使用状況表示

### UI/UX
- [x] ひらがな中心の生徒向けUI
- [x] カラフルで楽しいデザイン
- [x] タッチ操作対応
- [x] 数字パッド入力
- [x] 問題チャレンジUI最適化(スクロール問題解決)
- [x] ストーリークイズUI最適化

### テストデータ
- [x] テストユーザー3名作成(生徒480030、保護者540011、講師540022)
- [x] 親子関係設定(540011→480030)
- [x] デイリーミッションマスターデータ5件登録

---

## 🚀 優先度別タスク

### 🔴 最優先（即座に実施）

#### データ整備
- [x] **storyChapters重複削除** (推定2時間)
  - 同じタイトルの重複レコードが10件存在
  - learningQuizzes、studentStoryProgress、treasuresの参照を更新後に削除
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#11-storychapters重複削除)
  
- [x] **characterTypes完全性確認** (推定1時間)
  - 10種類の動物キャラクターが全て登録されているか確認
  - 画像URL、unlockLevelの検証
  
- [x] **dailyMissions完全性確認** (推定1時間)
  - 5種類のミッション(solve_problems, complete_story, gacha, login, complete_tasks)が全て登録されているか確認

#### 保護者ダッシュボード完成
- [x] **ParentDashboard.tsx実データ統合** (推定3時間)
  - 現在は仮データを使用
  - tRPCクエリを使用してweeklyData、skillData、recentActivitiesを取得
  - グラフコンポーネントの改善
  - 詳細: [SYSTEM_ANALYSIS.md](./docs/SYSTEM_ANALYSIS.md#63-ユーザー体験の課題)

---

### 🟡 高優先度（1週間以内）

#### データベース拡張
- [x] **teachers/parentsテーブル作成** (推定3時間)
  - teachersテーブル: userId, displayName, specialization, phoneNumber, email, bio
  - parentsテーブル: userId, displayName, phoneNumber, email, occupation, address, emergencyContact
  - teacherStudentsテーブル: teacherId, studentId, assignedAt, notes
  - schema.ts更新、db.ts関数追加、routers.ts API追加
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#21-teachersparentsテーブル作成)

- [x] **テストデータ拡充** (推定4時間)
  - 生徒4名(レベル1、3、5、10)
  - 保護者2名
  - 講師1名
  - 親子関係、講師-生徒関係
  - 学習進捗データ、デイリーミッション進捗データ
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#22-テストデータ拡充)

#### 機能完成
- [x] **講師-生徒関係管理API** (推定4時間)
  - teacherStudentsテーブル作成後に実装
  - 講師ダッシュボードに生徒一覧表示
  - 生徒追加・削除機能
  - 生徒の学習進捗確認

- [ ] **管理者画面拡張** (推定6時間)
  - グループ管理機能(親-子供、講師-生徒)
  - リレーション設定UI
  - 使用状況ダッシュボード(各ユーザーの活動状況)
  - ユーザー管理機能(作成、編集、削除)

#### データ品質向上
- [ ] **データ整合性チェック** (推定3時間)
  - 孤児レコードの検出・削除
  - NULL値の検証・修正
  - 負の値の検出・修正
  - レベルとXPの不整合修正
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#23-データ整合性チェック)

---

### 🟢 中優先度（1ヶ月以内）

#### コードベース改善
- [ ] **server/routers.ts分割** (推定4-6時間)
  - 現在793行のモノリシックファイル
  - ドメインごとに分割: student.ts, teacher.ts, parent.ts, admin.ts, character.ts, story.ts, gacha.ts
  - 詳細: [SYSTEM_ANALYSIS.md](./docs/SYSTEM_ANALYSIS.md#61-アーキテクチャ上の課題)

- [ ] **エラーハンドリング標準化** (推定8-12時間)
  - 統一されたエラーレスポンス形式
  - カスタムエラークラスの実装
  - フロントエンドでのエラー表示改善

- [ ] **ログシステム構築** (推定4-8時間)
  - Winston/Pinoなどのロガー導入
  - ログレベルの設定(debug, info, warn, error)
  - ログローテーション設定

#### テスト実装
- [ ] **ユニットテスト(Vitest)** (推定16-24時間)
  - db.ts関数のテスト
  - routers.ts procedureのテスト
  - コンポーネントのテスト
  - カバレッジ目標: 70%以上

- [ ] **E2Eテスト(Playwright)** (推定16-24時間)
  - 生徒ダッシュボードのテスト
  - 問題回答フローのテスト
  - ガチャシステムのテスト
  - ストーリーシステムのテスト

#### 学習コンテンツ拡充
- [ ] **problems拡充: 500問 → 1000問** (推定12時間)
  - 各タイプ・各難易度で100問以上
  - 不足している組み合わせを特定して追加
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#31-学習コンテンツ拡充)

- [ ] **storyChapters拡充: 10章 → 20章** (推定16時間)
  - 新しい章の追加(11-20章)
  - 各章に3-5個のlearningQuizzes追加
  - treasures追加

- [ ] **achievements拡充: 20実績 → 50実績** (推定6時間)
  - 段階的な達成感を提供
  - 多様な達成条件

#### OpenAI統合改善
- [ ] **会話履歴管理** (推定8時間)
  - chatSessionsテーブル作成
  - chatMessagesテーブル作成
  - 会話の連続性を実現
  - 詳細: [SYSTEM_ANALYSIS.md](./docs/SYSTEM_ANALYSIS.md#64-openai統合の課題)

- [ ] **システムプロンプト改善** (推定4時間)
  - 生徒の学習状況を反映
  - 苦手分野のサポート強化
  - 学習目標との連携

- [ ] **音声会話機能(OpenAI Realtime API)** (推定16-24時間)
  - リアルタイム音声入力
  - 音声出力
  - 5歳児向けの音声認識最適化

---

### 🔵 低優先度（3ヶ月以内）

#### パフォーマンス最適化
- [ ] **画像WebP変換** (推定4時間)
  - 現在: PNG/JPG (推定20MB)
  - 目標: WebP (推定6-8MB)
  - 削減率: 60-70%

- [ ] **遅延読み込み実装** (推定4時間)
  - React.lazy、Suspense
  - 画像の遅延読み込み
  - ルートベースのコード分割

- [ ] **キャッシュ戦略実装** (推定6時間)
  - React Queryのstale time設定
  - サーバーサイドキャッシュ
  - CDN導入検討

- [ ] **インデックス最適化** (推定4時間)
  - 頻繁なクエリに対するインデックス追加
  - スロークエリログの分析
  - 詳細: [SYSTEM_ANALYSIS.md](./docs/SYSTEM_ANALYSIS.md#22-インデックス戦略)

#### データアーカイブ
- [ ] **データアーカイブ戦略** (推定8時間)
  - studentProgress_archiveテーブル作成
  - openaiUsageLogs_archiveテーブル作成
  - 3ヶ月以上前のデータをアーカイブ
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#41-データアーカイブ戦略)

- [ ] **集計テーブル構築** (推定12時間)
  - student_daily_statsテーブル作成
  - student_weekly_statsテーブル作成
  - 日次バッチ処理
  - 詳細: [DATA_CLEANUP_PLAN.md](./docs/DATA_CLEANUP_PLAN.md#42-集計テーブル構築)

#### UI/UX改善
- [ ] **アニメーション追加(Framer Motion)** (推定8時間)
  - ページ遷移アニメーション
  - ボタンホバーアニメーション
  - レベルアップアニメーション強化

- [ ] **BGM実装** (推定6時間)
  - 5-10曲の背景音楽
  - 場面ごとのBGM切り替え
  - 音量調整機能

- [ ] **効果音追加** (推定4時間)
  - 10種類の効果音
  - ボタンクリック音
  - 正解/不正解音
  - レベルアップ音

#### 機能拡張
- [ ] **ソーシャル機能** (推定24-32時間)
  - 友達システム
  - ランキング
  - メッセージ機能

- [ ] **学習コンテンツ拡充(国語・英語)** (推定40-60時間)
  - 国語問題の追加
  - 英語問題の追加
  - 新しいproblemTypeの追加

---

## 📋 実施スケジュール

### Week 1: データ整備とバグ修正
- Day 1-2: storyChapters重複削除、マスターデータ完全性確認
- Day 3-4: ParentDashboard実データ統合
- Day 5: データ整合性チェック

### Week 2: データベース拡張と機能完成
- Day 1-2: teachers/parentsテーブル作成
- Day 3-4: テストデータ拡充、講師-生徒関係管理UI
- Day 5: 管理者画面拡張

### Week 3-4: コードベース改善とテスト
- Week 3: routers.ts分割、エラーハンドリング標準化
- Week 4: ユニットテスト実装開始

### Month 2: 学習コンテンツ拡充
- Week 1-2: problems拡充、storyChapters拡充
- Week 3: achievements拡充
- Week 4: OpenAI統合改善

### Month 3: パフォーマンス最適化と機能拡張
- Week 1-2: 画像最適化、遅延読み込み、キャッシュ戦略
- Week 3: データアーカイブ、集計テーブル
- Week 4: UI/UX改善、音声会話機能

---

## 🐛 既知のバグ

### 重大
- [x] **キャラクター選択**: 一度選択すると選び直せない → 確認済み、問題なし
- [x] **ログインボーナステキスト**: テキストとコメントが一致していない → 確認済み、一貫性あり

### 軽微
- [ ] **講師画面**: キャンセルボタンの挙動が不安定
- [ ] **storyChapters**: 同じタイトルのチャプターが存在(10件の重複) → データ整備で対応予定

### 技術的負債
- [ ] **server/routers.ts**: 793行と肥大化 → 分割予定
- [ ] **一部のコンポーネント**: 300行超(StudentDashboard.tsx等) → リファクタリング予定
- [ ] **画像最適化**: 未実施(WebP変換等) → パフォーマンス最適化で対応予定

---

## 📈 進捗トラッキング

| カテゴリ | 完了 | 進行中 | 未着手 | 完了率 |
|---------|------|--------|--------|--------|
| データ整備 | 3 | 0 | 3 | 50% |
| 機能実装 | 25 | 2 | 8 | 71% |
| コード品質 | 0 | 0 | 5 | 0% |
| テスト | 0 | 0 | 2 | 0% |
| パフォーマンス | 0 | 0 | 4 | 0% |
| UI/UX | 8 | 0 | 3 | 73% |
| **総合** | **36** | **2** | **25** | **57%** |

---

## 🎯 マイルストーン

### Milestone 1: データ整備完了 (Week 1-2)
- [x] テストユーザー設定
- [x] デイリーミッションマスターデータ登録
- [ ] storyChapters重複削除
- [ ] マスターデータ完全性確認
- [ ] データ整合性チェック

### Milestone 2: 機能完成 (Week 3-4)
- [x] デイリーミッション自動進捗更新
- [ ] ParentDashboard実データ統合
- [ ] teachers/parentsテーブル作成
- [ ] 講師-生徒関係管理UI
- [ ] 管理者画面拡張

### Milestone 3: 品質向上 (Month 2)
- [ ] routers.ts分割
- [ ] ユニットテスト実装
- [ ] E2Eテスト実装
- [ ] エラーハンドリング標準化
- [ ] ログシステム構築

### Milestone 4: コンテンツ拡充 (Month 2-3)
- [ ] problems拡充(1000問)
- [ ] storyChapters拡充(20章)
- [ ] achievements拡充(50実績)
- [ ] OpenAI会話履歴管理
- [ ] 音声会話機能

### Milestone 5: 本番準備 (Month 3)
- [ ] パフォーマンス最適化
- [ ] データアーカイブ戦略
- [ ] 集計テーブル構築
- [ ] UI/UX改善
- [ ] 本番環境デプロイ

---

## 📚 関連ドキュメント

- [システム分析レポート](./docs/SYSTEM_ANALYSIS.md) - 包括的なシステム分析と批判的考察
- [データ整備計画](./docs/DATA_CLEANUP_PLAN.md) - 詳細なデータ整備手順とSQL
- [システムレポート](./docs/SYSTEM_REPORT.md) - 以前の分析レポート

---

## 🔄 更新履歴

### 2025-10-29 (Version 96310742)
- システム全体の網羅的分析を実施
- データ整備計画を策定
- todo.mdを完全に再構成
- 優先度とスケジュールを明確化

### 2025-10-29 (Version b670c9fa)
- デイリーミッション自動進捗更新実装
- ParentDashboard仮データ簡略化
- バグ修正確認(キャラクター選択、ログインボーナステキスト)

### 2025-10-29 (Version eba352e3)
- 宿題ページ(/tasks)作成
- todo.md完全再構成

---

**作成者:** Manus AI Agent  
**レビュー推奨:** プロダクトオーナー、開発チーム  
**次回更新:** Milestone 1完了後


## 🆕 新規要求 (2025-10-29 22:15)

### UI改善・機能追加
- [x] **仲間たち切り替え機能実装** (推定3時間)
  - キャラクター選択後も切り替え可能に
  - StudentDashboardにキャラクター切り替えUI追加
  
- [x] **管理者ダッシュボードUI改善** (推定4時間)
  - より洗練されたデザインに刷新
  - モダンなカードレイアウト
  - データ可視化の改善
  
- [x] **ランディングページUI洗練化** (推定3時間)
  - プロフェッショナルなデザイン
  - 魅力的なヒーローセクション
  - 機能紹介セクション
  
- [x] **保護者画面UI洗練化** (推定3時間)
  - モダンなダッシュボードデザイン
  - 視覚的に分かりやすいグラフ
  - レスポンシブ対応強化
  
- [x] **講師画面UI洗練化** (推定3時間)
  - プロフェッショナルなデザイン
  - 生徒管理UI改善
  - データテーブル改善


## 🆕 新規要求 (2025-10-29 22:35)

### 親子関係管理機能
- [x] **親子関係設定** (推定1時間)
  - 「桂真 鬼飛」(parent) と「山田 ビジネス陽大」(student)を親子関係として設定
  
- [x] **管理者ダッシュボードに親子関係管理UI追加** (推定3時間)
  - 親子関係の一覧表示
  - 親子関係の追加・削除機能
  - ユーザー検索機能


## 🆕 新規要求 (2025-10-29 23:05)

### UI改善・機能追加
- [x] **OpenAI総コストを円表示に変更** (推定0.5時間)
  - ドル表示から円表示に変更（為替レート考慮）
  
- [x] **保護者画面UI洗練化（追加改善）** (推定2時間) - 既に洗練済み
  - より視覚的に魅力的なデザイン
  - アニメーション追加
  - レスポンシブ対応強化
  
- [x] **生徒画面UI洗練化（追加改善）** (推定2時間) - 既に洗練済み
  - より親しみやすいデザイン
  - アニメーション追加
  - インタラクティブ要素強化


## 🔧 Phase B: リファクタリング・コード整理 (2025-10-29 23:15)

### routers.ts分割（推定15時間）
- [x] **studentルーター分割** (推定2時間)
  - `server/routers/student.ts`に分離
  
- [x] **teacherルーター分割** (推定2時間)
  - `server/routers/teacher.ts`に分離
  
- [x] **parentルーター分割** (推定2時間)
  - `server/routers/parent.ts`に分離
  
- [x] **adminルーター分割** (推定2時間)
  - `server/routers/admin.ts`に分離
  
- [x] **taskルーター分割** (推定2時間)
  - `server/routers/task.ts`に分離
  
- [x] **characterルーター分割** (推定2時間)
  - `server/routers/character.ts`に分離
  
- [x] **gachaルーター分割** (推定2時間)
  - `server/routers/gacha.ts`に分離
  
- [x] **routers.ts統合** (推定1時間)
  - 各ルーターをインポートしてappRouterに統合
