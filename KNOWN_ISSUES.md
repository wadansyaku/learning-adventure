# 既知の問題

## ガチャ結果表示問題

**症状:**
- ガチャボタンをクリックすると、コインは正常に消費される（10枚減る）
- しかし、ガチャ結果画面が表示されない
- データベースには正常にアイテムが追加されている

**調査結果:**
1. `server/routers/gacha.ts`の`roll`エンドポイントは正常に動作している
2. `addStudentItem`関数は正常に動作している（`characterId: null`を追加済み）
3. `Gacha.tsx`の`rollGachaMutation.onSuccess`コールバックが呼ばれていない可能性がある
4. ブラウザコンソールに500エラーが表示されるが、サーバーログにはエラーが記録されていない

**次のステップ:**
1. `rollGachaMutation.onSuccess`が呼ばれているか確認するため、デバッグログを追加
2. サーバーからのレスポンスを確認
3. TRPCのエラーハンドリングを確認

**回避策:**
- インベントリページで獲得したアイテムを確認できる
- コインは正常に消費されている

---

## その他の未解決問題

### キャラクター選択
- 「なかまをえらぶ」ボタンを押すと「もう仲間がいるよ」と表示される
- しかし、実際にはキャラクターが設定されていない可能性がある
- **修正済み**: 既存キャラクターチェックを追加し、既にキャラクターを持っている場合は生徒ダッシュボードにリダイレクト

---

## 修正済みの問題

### ガチャのデータベースエラー（修正済み）
- **症状**: `studentItems`テーブルへの挿入時に`characterId`カラムエラー
- **原因**: `addStudentItem`関数で`characterId`を指定していなかった
- **修正**: `characterId: null`を明示的に指定

### キャラクター選択の`userId`/`studentId`混同（修正済み）
- **症状**: 「けってい」ボタンをクリックすると500エラー
- **原因**: `server/routers/character.ts`で`userId`を使っていたが、実際のテーブルは`studentId`を使用
- **修正**: `getStudentByUserId`を使って`studentId`を取得してから処理

### 生徒ダッシュボードのレイアウト（修正済み）
- **症状**: 4列レイアウトで表示が崩れる
- **修正**: 3列レイアウトに変更（`lg:grid-cols-3`）
